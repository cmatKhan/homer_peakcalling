/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Nextflow config file for running minimal tests
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Defines input files and everything required to run a fast and simple pipeline test.

    Use as follows:
        nextflow run cmatkhan/homer_peakcalling_from_bam -profile test,<docker/singularity> --outdir <OUTDIR>

----------------------------------------------------------------------------------------
*/

process {

    withName: 'SAMTOOLS_VIEW' {
        ext.prefix = { "${meta.id}_filtered" } 
        ext.args = [
            "-F 0x0004",      // Exclude unmapped reads
            "-F 0x0008",      // Exclude reads with unmapped mates
            "-F 0x0100",      // Exclude secondary alignments
            "-F 0x0800",      // Exclude supplementary alignments
            "-f 0x0002",      // INCLUDE only properly paired reads
            "-q 10"           // Minimum MAPQ of 10
        ].join(' ').trim()
    }

    withName: '.*:HOMER_.*MAKETAGDIRECTORY.*' {
        ext.args = [
        '-checkGC'
    ].join(' ')
        
    }
    
    withName: '.*:HOMER_*FINDPEAKS.*' {
        ext.args = [
            '-fragLength 1',      // Do not shift reads
            '-L 2',               // Local fold enrichment (2-fold)
            '-minDist 100',       // Minimum distance between peaks (doublet detection)
            '-LP 0.001',          // Local poisson p-value (relaxed from 0.0001)
            '-F 4',               // Control fold enrichment (4-fold)
            '-P 0.001',           // Control poisson p-value (relaxed from 0.0001)
            '-fdr 0.05',          // Overall false discovery rate
            '-localSize 1000',    // Local background window
            '-C 0',               // Disable clonal filtering for MNase experiments
            params.homer_gsize ? "-gsize ${params.homer_gsize}" : ""
        ].join(' ')

    }

    withName: '.*:HOMER_ANNOTATEPEAKS_MERGED' {
        ext.args = [
            '-fragLength 1'
        ].join(' ').trim()
    }

    withName: '.*:HOMER_QUANTIFYPEAKS' {
        ext.args = [
            params.homer_quant_size ? "-size ${params.homer_quant_size}" : "-size given",
            params.homer_quant_raw ? "-raw" : "",
            '-fragLength 1'
        ].join(' ').trim()
    }

    withName: '.*:HOMER_QUANTIFYTSS' {
        ext.prefix = "promoter_enrichment"
        ext.args = [
            params.homer_quant_size ? "-size ${params.homer_quant_size}" : "-size given",
            params.homer_quant_raw ? "-raw" : "",
            '-fragLength 1'
        ].join(' ').trim()
    }

}

